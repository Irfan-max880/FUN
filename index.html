<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Haunted Runner Fixed</title>
<style>
  body { margin:0; background:black; overflow:hidden; }
  canvas { display:block; margin:auto; background:black; }
</style>
</head>
<body>
<canvas id="game" width="1100" height="520"></canvas>

<audio id="bgMusic" loop preload="auto">
  <source src="https://cdn.pixabay.com/download/audio/2021/10/26/audio_9b2db5a5de.mp3?filename=haunted-house-ambience-1-minute-110057.mp3" type="audio/mpeg">
</audio>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// Images
const playerImg = new Image(); playerImg.src = "https://i.postimg.cc/jdn1KZYb/Screenshot-20250812-001657-removebg-preview.png";
const ghostImg  = new Image(); ghostImg.src  = "https://i.postimg.cc/vDwc43PK/Screenshot-2025-0812-174643-removebg-preview.png";
const bgImg     = new Image(); bgImg.src     = "https://i.postimg.cc/L5tmbRTy/Screenshot-2025-0812-173844.png";
const pumpkinImg= new Image(); pumpkinImg.src= "https://i.postimg.cc/FK6CkBSG/Screenshot-2025-0812-180233-removebg-preview.png";
const fogImg    = new Image(); fogImg.crossOrigin = "anonymous";
fogImg.src      = "https://i.ibb.co/dKnmp53/fog-texture.png"; // Large seamless fog texture

// Player
let player = { x:100, y:400, w:80, h:100, vy:0, jumping:false };
const gravity = 0.8;

// Ghost
let ghost = { x:-300, y:400, w:120, h:140, speed:0.3, chasing:false, chaseTimer:0, minDistance:150 };

// Pumpkins & Bullets
let pumpkins = [];
let bullets = [];
let particles = [];
let pumpkinTimer = 0;

// Score
let score = 0;
let gameOver = false;

// Music
const bgMusic = document.getElementById("bgMusic");
let musicStarted = false;
function startMusic() {
  if (!musicStarted) {
    bgMusic.play()
      .then(() => { musicStarted = true; })
      .catch(() => { /* retry later */ });
  }
}

// Input
document.addEventListener("keydown", e => {
  startMusic();
  if ((e.code === "Space" || e.code === "ArrowUp") && !player.jumping && !gameOver) {
    player.vy = -15;
    player.jumping = true;
  }
  if (e.code === "Enter" && gameOver) restartGame();
  if (e.code === "KeyF" && !gameOver) shoot();
});
canvas.addEventListener("click", e => {
  startMusic();
  if (e.shiftKey) shoot();
  else if (!player.jumping && !gameOver) {
    player.vy = -15;
    player.jumping = true;
  }
  if (gameOver) restartGame();
});

function shoot() {
  bullets.push({ x: player.x + player.w, y: player.y + player.h/2 - 5, w:15, h:5, speed:8 });
}

// Particle effect
function spawnParticles(x,y) {
  for (let i=0; i<6; i++) {
    particles.push({
      x, y,
      vx: (Math.random()-0.5)*4,
      vy: (Math.random()-1)*4,
      life: 30
    });
  }
}

function loop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Background
  if (bgImg.complete) ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);
  ctx.fillStyle = "rgba(0,0,0,0.4)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Spawn pumpkins
  pumpkinTimer++;
  if (pumpkinTimer > 150) {
    pumpkins.push({ x:canvas.width, y:440, w:50, h:50, glow:0 });
    pumpkinTimer = 0;
  }

  // Draw pumpkins
  pumpkins.forEach((p,pi) => {
    p.x -= 5;
    p.glow += 0.1;

    // Bullet collision
    bullets.forEach((b,bi) => {
      if (rectsOverlap(b,p)) {
        pumpkins.splice(pi,1);
        bullets.splice(bi,1);
        spawnParticles(p.x + p.w/2, p.y + p.h/2);
      }
    });

    // Player collision
    if (checkPumpkinCollision(player,p)) {
      ghost.chasing = true;
      ghost.speed = 2.5;
      ghost.chaseTimer = 180;
    }

    ctx.save();
    ctx.shadowColor = "orange";
    ctx.shadowBlur = 15 + 5*Math.sin(p.glow);
    ctx.drawImage(pumpkinImg,p.x,p.y,p.w,p.h);
    ctx.restore();
  });
  pumpkins = pumpkins.filter(p => p.x + p.w > 0);

  // Bullets
  bullets.forEach(b => {
    b.x += b.speed;
    ctx.fillStyle = "yellow";
    ctx.fillRect(b.x,b.y,b.w,b.h);
  });
  bullets = bullets.filter(b => b.x < canvas.width);

  // Particles
  particles.forEach((pt, i) => {
    pt.x += pt.vx;
    pt.y += pt.vy;
    pt.vy += 0.1;
    pt.life--;
    ctx.fillStyle = "orange";
    ctx.fillRect(pt.x, pt.y, 3, 3);
    if (pt.life <= 0) particles.splice(i,1);
  });

  // Player physics
  player.y += player.vy;
  player.vy += gravity;
  if (player.y >= 400) { player.y = 400; player.jumping = false; }

  // Ghost movement
  if (!ghost.chasing) {
    ghost.speed = 0.3;
    if (ghost.x < player.x - ghost.minDistance) {
      ghost.x += ghost.speed;
    }
  } else {
    ghost.x += ghost.speed;
    ghost.chaseTimer--;
    if (ghost.chaseTimer <= 0) {
      ghost.chasing = false;
    }
  }

  // Ghost collision using smaller hitbox
  let ghostHitbox = {
    x: ghost.x + 20,
    y: ghost.y + 10,
    w: ghost.w - 40,
    h: ghost.h - 20
  };
  if (rectsOverlap(player, ghostHitbox)) gameOver = true;

  // Draw ghost
  ctx.drawImage(ghostImg, ghost.x, ghost.y, ghost.w, ghost.h);

  // Draw player
  ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);

  // Fog layer
  if (fogImg.complete) {
    let pattern = ctx.createPattern(fogImg, "repeat");
    ctx.save();
    ctx.globalAlpha = 0.3;
    ctx.translate(-Date.now()*0.05 % fogImg.width, 0);
    ctx.fillStyle = pattern;
    ctx.fillRect(0,0,canvas.width+fogImg.width,canvas.height);
    ctx.restore();
  }

  // Score
  ctx.fillStyle = "white";
  ctx.font = "20px Arial";
  ctx.fillText("Score: " + score, 20, 30);

  if (!gameOver) requestAnimationFrame(loop);
  else {
    ctx.fillStyle="white";
    ctx.font="40px Arial";
    ctx.fillText("GAME OVER", canvas.width/2 - 120, canvas.height/2);
    ctx.font="20px Arial";
    ctx.fillText("Press Enter or Click to Restart", canvas.width/2 - 160, canvas.height/2 + 40);
  }
}

// Collision helpers
function checkPumpkinCollision(player,p) {
  return rectsOverlap(player, p) && player.y + player.h > p.y + 20;
}
function rectsOverlap(a,b) {
  return a.x < b.x + b.w &&
         a.x + a.w > b.x &&
         a.y < b.y + b.h &&
         a.y + a.h > b.y;
}

function restartGame() {
  pumpkins = [];
  bullets = [];
  particles = [];
  pumpkinTimer = 0;
  ghost.x = -300;
  ghost.speed = 0.3;
  ghost.chasing = false;
  ghost.chaseTimer = 0;
  score = 0;
  gameOver = false;
  loop();
}

// Start game when fog is ready
fogImg.onload = () => loop();
</script>
</body>
</html>
